.row
  .span6.offset3
    = render 'chat'

    = link_to 'Thank you and exit', '#', class: 'btn btn-danger finish_button'

:javascript
  var chatTimerOffset = #{ @chat.started_offset(-1) };

  var CONNECTION_TIMEOUT_LIMIT = 30 * 1000;
  var connectionTimer = setTimeout(function(){
    sendConnectionTimeup();
  }, CONNECTION_TIMEOUT_LIMIT);

  var CHAT_TIMEOUT_LIMIT = 3 * 60 * 1000;
  var CHAT_TIMEOUT_WARNING = 10 * 1000;


  // Enable pusher logging - don't include this in production
  Pusher.log = function(message) {
    if (window.console && window.console.log) window.console.log(message);
  };

  // Flash fallback logging - don't include this in production
  WEB_SOCKET_DEBUG = true;

  var pusher = new Pusher('13ea71fd49c7de808650');
  var channel = pusher.subscribe("channel_chat_#{@chat.id}");

  function initTimer(offset) {
    timer = K.Timer(offset);
    timer.start();
    timer.promise().progress( function (value) {
      updateTimerUI(value);
     });

    timer.promise().done( function (value) {
      updateTimerUI(value);
      console.log('finished');
    });
  }
  channel.bind('chat_event', function(data) {

    if (data.author_id == #{current_user.id}) {
      $(data.html).addClass('me_msg').appendTo('#messages');
    } else {
      $(data.html).appendTo('#messages');
      $('#typing_msg').remove();
    }

    if (window.Cocoa) {
      Cocoa.log(data.message);
    }
  });

  // Handling status events coming with pusher
  channel.bind('chat_status_event', function(data) {
    if (data && data.message) {
      insertStatusMessage(data.message)
    }

    // FIX: this should not be here
    // It is to detect when the villager joined the discussion
    if (connectionTimer !== undefined) {
      clearTimeout(connectionTimer);
      connectionTimer = undefined;
    };
  });

  channel.bind('chat_start_event', function(data) {
    initTimer(0);
  });

  function insertStatusMessage(message) {
    $('<p>' + message + '</p>').addClass('status_msg').appendTo('#messages');
  }


  function sendConnectionTimeup() {
    $.ajax({
      url: "#{connection_timeout_chat_path(@chat)}",
      type: "post",
      success: function() {
        insertStatusMessage('No one picked up')
      },
      error: function(error) {
        console.error(error);
      }
    });
  };

  function sendChatTimeup() {
    $.ajax({
      url: "#{chat_timeout_chat_path(@chat)}",
      type: "post",
      success: function() { },
      error: function(error) {
        console.error(error);
      }
    });
  };

  $('.finish_button').click(function(e) {
    e.preventDefault();

    var thankyouMessage = prompt('Please say thank you to the villager');
    // after guest enter the 'thank you' message
    $.ajax({
      url: "#{finish_chat_path(@chat)}",
      type: "post",
      data: { message: thankyouMessage },
      success: function() {
        window.location = "#{review_chat_path(@chat)}";
      },
      error: function(error) {
        console.error(error);
      }
    });
  });
